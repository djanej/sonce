<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News – Sonce Slovenije</title>
    <meta name="description" content="Novice in objave Sindikat Sonce Koper.">
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f97316',
                        'primary-hover': '#ea580c'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/news/news.css">
    <style>
        .news-lock-overlay { display: none !important; }
        .news-locked .news-lock-overlay { display: flex !important; }
        .news-locked body > *:not(.news-lock-overlay) { filter: blur(2px); pointer-events: none; user-select: none; }
    </style>
    <script>
        (function(){
            var CORRECT_PIN = '4532';
            var STORAGE_KEY = 'newsUnlocked';
            var PIN_PARAM = 'pin';
            
            // Check URL parameter first
            try {
                var params = new URLSearchParams(location.search);
                var pin = params.get(PIN_PARAM);
                if (pin === CORRECT_PIN){
                    try { 
                        localStorage.setItem(STORAGE_KEY, '1'); 
                        console.log('News unlocked via URL parameter');
                    } catch(e){
                        console.warn('localStorage not available:', e);
                    }
                    // Clean URL
                    params.delete(PIN_PARAM);
                    var qs = params.toString();
                    var newUrl = location.pathname + (qs ? ('?' + qs) : '');
                    history.replaceState(null, '', newUrl);
                }
            } catch(e){
                console.warn('Error processing URL parameters:', e);
            }
            
            // Check localStorage
            var unlocked = false;
            try { 
                unlocked = localStorage.getItem(STORAGE_KEY) === '1'; 
            } catch(e){
                console.warn('localStorage not available:', e);
            }
            
            if (!unlocked){
                document.documentElement.classList.add('news-locked');
                console.log('News section locked - PIN required');
            } else {
                console.log('News section unlocked');
                // Ensure overlay is hidden when unlocked
                var overlay = document.querySelector('.news-lock-overlay');
                if (overlay) overlay.style.display = 'none';
            }
        })();
    </script>
    <link rel="canonical" href="https://sonce.org/news/">
    <meta property="og:site_name" content="Sonce Slovenije">
    <meta property="og:type" content="website">
    <meta property="og:title" content="News – Sonce Slovenije">
    <meta property="og:description" content="Najnovejše novice in objave iz sveta Sindikata Sonce Koper">
    <meta property="og:url" content="https://sonce.org/news/">
    <meta property="og:image" content="https://sonce.org/images/soncelogo.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="News – Sonce Slovenije">
    <meta name="twitter:description" content="Najnovejše novice in objave iz sveta Sindikata Sonce Koper">
    <meta name="twitter:image" content="https://sonce.org/images/soncelogo.jpg">
    <script id="news-jsonld" type="application/ld+json">{}</script>
</head>
<body class="bg-gray-50">
    <div class="news-lock-overlay fixed inset-0 z-50 bg-white/90 backdrop-blur flex items-center justify-center p-6">
        <div class="max-w-md w-full bg-white border border-gray-200 rounded-2xl shadow-xl p-8 text-center">
            <div class="mx-auto mb-4 w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.656 0 3-1.344 3-3s-1.344-3-3-3-3 1.344-3 3 1.344 3 3 3zM5 21v-2a7 7 0 0114 0v2H5z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Stran v razvoju</h2>
            <p class="text-gray-600 mb-6">Za ogled novic vnesite PIN za testiranje.</p>
            <form id="news-pin-form" class="flex items-center gap-3" autocomplete="off">
                <input id="news-pin-input" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="8" placeholder="PIN" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500" />
                <button type="submit" class="px-4 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500">Odkleni</button>
            </form>
            <p id="news-pin-error" class="mt-3 text-sm text-red-600 hidden" role="alert" aria-live="polite">Napačen PIN. Poskusite znova.</p>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button id="lock-news-btn" type="button" class="text-xs text-gray-400 hover:text-gray-600 underline">Zakleni za testiranje</button>
            </div>
        </div>
    </div>
    <script>
        (function(){
            var CORRECT_PIN = '4532';
            var STORAGE_KEY = 'newsUnlocked';
            var form = document.getElementById('news-pin-form');
            var input = document.getElementById('news-pin-input');
            var error = document.getElementById('news-pin-error');
            
            if (form && input){
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    var value = (input.value || '').trim();
                    
                    if (value === CORRECT_PIN){
                        try { 
                            localStorage.setItem(STORAGE_KEY, '1'); 
                            console.log('News unlocked via form submission');
                        } catch(e){
                            console.warn('localStorage not available:', e);
                        }
                        document.documentElement.classList.remove('news-locked');
                        if (error) error.classList.add('hidden');
                        
                        // Hide the overlay completely
                        var overlay = document.querySelector('.news-lock-overlay');
                        if (overlay) overlay.style.display = 'none';
                        
                        // Clear the input
                        input.value = '';
                        
                        // Show success message briefly
                        var successMsg = document.createElement('p');
                        successMsg.textContent = 'Uspešno odklejeno!';
                        successMsg.className = 'mt-3 text-sm text-green-600';
                        successMsg.setAttribute('role', 'alert');
                        successMsg.setAttribute('aria-live', 'polite');
                        
                        if (error) {
                            error.parentNode.insertBefore(successMsg, error.nextSibling);
                            setTimeout(function(){
                                if (successMsg.parentNode) {
                                    successMsg.parentNode.removeChild(successMsg);
                                }
                            }, 2000);
                        }
                    } else {
                        if (error) error.classList.remove('hidden');
                        input.focus();
                        if (input.select) input.select();
                        
                        // Add shake animation
                        input.classList.add('animate-pulse');
                        setTimeout(function(){
                            input.classList.remove('animate-pulse');
                        }, 500);
                    }
                });
                
                // Allow Enter key to submit
                input.addEventListener('keypress', function(e){
                    if (e.key === 'Enter') {
                        form.dispatchEvent(new Event('submit'));
                    }
                });
            }
            
            // Add lock button functionality for testing
            var lockBtn = document.getElementById('lock-news-btn');
            if (lockBtn) {
                lockBtn.addEventListener('click', function(){
                    try {
                        localStorage.removeItem(STORAGE_KEY);
                        console.log('News section locked for testing');
                        document.documentElement.classList.add('news-locked');
                        var overlay = document.querySelector('.news-lock-overlay');
                        if (overlay) overlay.style.display = 'flex';
                    } catch(e){
                        console.warn('Error locking news section:', e);
                    }
                });
            }
        })();
    </script>
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                    <img src="/images/soncelogo.jpg" alt="Sonce Slovenije" class="h-10 w-auto" loading="eager" decoding="async">
                    <span class="text-gray-900 font-semibold text-lg">Sonce Slovenije</span>
                </a>
                <nav class="hidden md:flex items-center gap-6">
                    <a href="/" class="text-gray-700 hover:text-orange-600 transition-colors">Domov</a>
                    <a href="/news/" class="text-orange-600 font-semibold border-b-2 border-orange-600 pb-1">News</a>
                </nav>
                <div class="md:hidden">
                    <a href="/" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        Domov
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-10 max-w-7xl">
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">News</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">Najnovejše novice in objave iz sveta Sindikata Sonce Koper</p>
        </div>
        
        <div id="news-controls" class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div id="tag-filter" class="flex flex-wrap gap-2"></div>
            <div class="w-full md:w-80">
                <label for="search" class="sr-only">Išči</label>
                <div class="relative">
                    <input id="search" type="search" placeholder="Išči novice..." class="w-full border border-gray-300 rounded-lg pl-10 pr-3 py-2 text-sm bg-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500" autocomplete="off">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 110-16 8 8 0 010 16z"></path>
                    </svg>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <label for="sort-by" class="text-sm font-medium text-gray-700">Razvrsti:</label>
                <select id="sort-by" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="date_desc" selected>Najnovejše</option>
                    <option value="date_asc">Najstarejše</option>
                    <option value="title_asc">Naslov A–Ž</option>
                    <option value="title_desc">Naslov Ž–A</option>
                    <option value="readtime_asc">Čas branja ↑</option>
                    <option value="readtime_desc">Čas branja ↓</option>
                </select>
                <label for="page-size" class="text-sm font-medium text-gray-700">Na stran:</label>
                <select id="page-size" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="6">6</option>
                    <option value="9">9</option>
                    <option value="12" selected>12</option>
                    <option value="18">18</option>
                </select>
            </div>
        </div>
        
        <div id="news-list" class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3"></div>
        
        <div id="loading" class="text-center py-12">
            <div class="inline-flex items-center gap-2 text-gray-600">
                <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Nalaganje novic...
            </div>
        </div>
        
        <nav id="pagination" class="mt-12 flex items-center justify-center gap-2"></nav>
        <div id="empty-state" class="hidden text-center py-16" role="status" aria-live="polite">
            <div class="max-w-md mx-auto">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Ni objav za prikaz</h3>
                <p class="text-gray-600">Trenutno ni na voljo nobenih objav. Preverite pozneje.</p>
            </div>
        </div>
    </main>

    <footer class="mt-20 py-12 bg-gray-900 text-white">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; <span id="year"></span> Sonce Slovenije. Vse pravice pridržane.</p>
        </div>
    </footer>

    <script>
        (function(){
            const elements = {
                list: document.getElementById('news-list'),
                empty: document.getElementById('empty-state'),
                loading: document.getElementById('loading'),
                pagination: document.getElementById('pagination'),
                tagFilter: document.getElementById('tag-filter'),
                pageSizeSelect: document.getElementById('page-size'),
                searchInput: document.getElementById('search'),
                sortSelect: document.getElementById('sort-by'),
                year: document.getElementById('year')
            };

            const state = {
                allPosts: [],
                filteredPosts: [],
                currentPage: 1,
                pageSize: 12,
                activeTag: null,
                query: '',
                sortBy: 'date_desc'
            };

            const BASE_URL = 'https://sonce.org';

            function escapeHtml(str){
                const p = document.createElement('p');
                p.appendChild(document.createTextNode(str || ''));
                return p.innerHTML;
            }

            function stripHtml(input){
                if (!input) return '';
                const div = document.createElement('div');
                div.innerHTML = String(input);
                return (div.textContent || div.innerText || '').trim();
            }

            function truncate(text, max){
                const limit = typeof max === 'number' ? max : 180;
                if (!text) return '';
                if (text.length <= limit) return text;
                const sliced = text.slice(0, limit);
                const lastSpace = sliced.lastIndexOf(' ');
                const safeCut = lastSpace > limit * 0.6 ? lastSpace : limit;
                return sliced.slice(0, safeCut).trim() + '…';
            }

            function generateExcerpt(post){
                const candidate = post.summary || post.excerpt || post.description || post.teaser;
                if (candidate) return truncate(stripHtml(candidate), 180);
                const source = post.html || post.content || post.body || post.text;
                if (source){
                    const firstBlock = String(source).split(/\n{2,}/)[0];
                    return truncate(stripHtml(firstBlock), 180);
                }
                return '';
            }

            function formatDate(iso){
                try {
                    return new Date(iso).toLocaleDateString('sl-SI', { year:'numeric', month:'long', day:'numeric' });
                } catch(e){
                    return iso || '';
                }
            }

            function normalizeTags(tags){
                if (!tags) return [];
                if (Array.isArray(tags)) return tags.map(t => String(t).trim()).filter(Boolean);
                if (typeof tags === 'string') return tags.split(',').map(t => t.trim()).filter(Boolean);
                return [];
            }

            function normalizeText(s){
                return String(s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }

            function debounce(fn, wait){
                let t;
                return (...args) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn.apply(null, args), wait);
                };
            }

            function normalizePost(p){
                const slug = p.slug || (p.title ? String(p.title).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') : '');
                const hero = p.hero || p.image || p.cover || '';
                const tags = normalizeTags(p.tags || p.tag || p.categories || p.category);
                return { ...p, slug, hero, tags };
            }

            function getUniqueTags(posts){
                const s = new Set();
                posts.forEach(p => (p.tags || []).forEach(t => s.add(t)));
                return Array.from(s).sort((a,b)=> a.localeCompare(b,'sl'));
            }

            function readQuery(){
                const qs = new URLSearchParams(location.search);
                const page = parseInt(qs.get('page') || '1', 10);
                const size = parseInt(qs.get('size') || '', 10);
                state.currentPage = Number.isFinite(page) && page > 0 ? page : 1;
                state.pageSize = Number.isFinite(size) && size > 0 ? size : state.pageSize;
                const tag = qs.get('tag');
                state.activeTag = tag && tag.trim() ? tag.trim() : null;
                const q = qs.get('q') || '';
                state.query = q.trim();
                const sort = qs.get('sort') || '';
                const allowedSorts = ['date_desc','date_asc','title_asc','title_desc','readtime_asc','readtime_desc'];
                state.sortBy = allowedSorts.includes(sort) ? sort : 'date_desc';
                if (elements.pageSizeSelect) elements.pageSizeSelect.value = String(state.pageSize);
                if (elements.searchInput) elements.searchInput.value = state.query;
                if (elements.sortSelect) elements.sortSelect.value = state.sortBy;
            }

            function writeQuery(){
                const qs = new URLSearchParams();
                if (state.currentPage > 1) qs.set('page', String(state.currentPage));
                if (state.pageSize !== 12) qs.set('size', String(state.pageSize));
                if (state.activeTag) qs.set('tag', state.activeTag);
                if (state.query) qs.set('q', state.query);
                if (state.sortBy && state.sortBy !== 'date_desc') qs.set('sort', state.sortBy);
                const q = qs.toString();
                const url = q ? `?${q}` : location.pathname;
                history.replaceState(null, '', url);
            }

            function renderPosts(){
                elements.list.innerHTML = '';
                const total = state.filteredPosts.length;
                
                if (!total){
                    elements.empty.classList.remove('hidden');
                    elements.loading.classList.add('hidden');
                    return;
                }
                
                elements.empty.classList.add('hidden');
                elements.loading.classList.add('hidden');
                
                const start = (state.currentPage - 1) * state.pageSize;
                const end = start + state.pageSize;
                const pagePosts = state.filteredPosts.slice(start, end);
                const frag = document.createDocumentFragment();
                
                pagePosts.forEach(p => {
                    const a = document.createElement('a');
                    a.href = (p.path || p.link) ? `/news/post.html?path=${encodeURIComponent(p.path || p.link)}` : `/news/post.html?slug=${encodeURIComponent(p.slug)}`;
                    a.className = 'news-card block rounded-2xl overflow-hidden bg-white border border-gray-200 shadow-sm hover:shadow-lg transition-all duration-300 hover:-translate-y-1';
                    a.setAttribute('aria-label', `${p.title || 'Objava'} – ${formatDate(p.date)}${p.author ? `, ${p.author}` : ''}`);
                    
                                    const excerpt = generateExcerpt(p);
                const hasImage = (p.hero && p.hero.trim()) || (p.image && p.image.trim());
                const imageSrc = p.hero || p.image || '';
                const readingTime = (Number.isFinite(p.readingTimeMinutes) && p.readingTimeMinutes > 0) ? `${p.readingTimeMinutes} min` : '';
                
                a.innerHTML = `
                    <div class="media aspect-[16/9] ${hasImage ? 'bg-gray-100' : 'bg-gradient-to-br from-orange-50 to-orange-100'} overflow-hidden">
                        ${hasImage ? 
                            `<img src="${escapeHtml(imageSrc)}" alt="${escapeHtml(p.imageAlt || p.title || '')}" class="w-full h-full object-cover" loading="lazy" decoding="async" onerror="this.style.display='none'; this.parentElement.classList.add('bg-gradient-to-br', 'from-orange-50', 'to-orange-100');">` :
                                `<div class="w-full h-full flex items-center justify-center">
                                    <svg class="w-16 h-16 text-orange-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 01-2-2V9a2 2 0 012-2h2a2 2 0 012 2v10a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>`
                            }
                        </div>
                        <div class="p-6">
                            <div class="flex items-center gap-2 text-sm text-gray-500 mb-3">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span>${formatDate(p.date)}</span>
                                ${p.author ? `<span class="mx-2">•</span><span>${escapeHtml(p.author)}</span>` : ''}
                                ${readingTime ? `<span class="mx-2">•</span><span aria-label="Čas branja">${readingTime}</span>` : ''}
                            </div>
                            <h2 class="text-xl font-bold text-gray-900 mb-2 leading-tight line-clamp-2">${escapeHtml(p.title || '')}</h2>
                            <p class="text-gray-700 leading-relaxed mb-4 line-clamp-3">${escapeHtml(excerpt)}</p>
                            ${p.tags && p.tags.length ? `<div class="flex flex-wrap gap-2 mb-4">${p.tags.map(t => `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
                            <div class="flex items-center gap-2 text-orange-600 font-medium text-sm">
                                Preberi več
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>`;
                    
                    frag.appendChild(a);
                });
                
                elements.list.appendChild(frag);
            }

            function renderPagination(){
                const total = state.filteredPosts.length;
                const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
                elements.pagination.innerHTML = '';
                
                if (totalPages <= 1){
                    return;
                }
                
                const makeBtn = (label, page, disabled, isActive) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = label;
                    btn.className = `pagination-btn ${isActive ? 'active' : ''}`;
                    
                    if (disabled){
                        btn.disabled = true;
                    } else {
                        btn.addEventListener('click', () => {
                            state.currentPage = page;
                            writeQuery();
                            renderPosts();
                            renderPagination();
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        });
                    }
                    return btn;
                };
                
                const prev = makeBtn('← Prejšnja', Math.max(1, state.currentPage - 1), state.currentPage === 1, false);
                elements.pagination.appendChild(prev);
                
                const windowSize = 5;
                let start = Math.max(1, state.currentPage - Math.floor(windowSize/2));
                let end = Math.min(totalPages, start + windowSize - 1);
                
                if (end - start + 1 < windowSize){
                    start = Math.max(1, end - windowSize + 1);
                }
                
                if (start > 1){
                    elements.pagination.appendChild(makeBtn('1', 1, false, state.currentPage === 1));
                    if (start > 2){
                        const dots = document.createElement('span');
                        dots.textContent = '…';
                        dots.className = 'px-3 py-2 text-gray-400';
                        elements.pagination.appendChild(dots);
                    }
                }
                
                for (let i = start; i <= end; i++){
                    elements.pagination.appendChild(makeBtn(String(i), i, false, state.currentPage === i));
                }
                
                if (end < totalPages){
                    if (end < totalPages - 1){
                        const dots = document.createElement('span');
                        dots.textContent = '…';
                        dots.className = 'px-3 py-2 text-gray-400';
                        elements.pagination.appendChild(dots);
                    }
                    elements.pagination.appendChild(makeBtn(String(totalPages), totalPages, false, state.currentPage === totalPages));
                }
                
                const next = makeBtn('Naslednja →', Math.min(totalPages, state.currentPage + 1), state.currentPage === totalPages, false);
                elements.pagination.appendChild(next);
            }

            function renderTagFilter(){
                const tags = getUniqueTags(state.allPosts);
                elements.tagFilter.innerHTML = '';
                
                if (!tags.length){
                    elements.tagFilter.parentElement?.classList?.add('hidden');
                    return;
                }
                
                elements.tagFilter.parentElement?.classList?.remove('hidden');
                
                const makeTag = (label, value) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = label;
                    btn.className = `tag-pill ${state.activeTag === value ? 'active' : ''}`;
                    btn.addEventListener('click', () => {
                        state.activeTag = value;
                        state.currentPage = 1;
                        writeQuery();
                        applyFilters();
                    });
                    return btn;
                };
                
                elements.tagFilter.appendChild(makeTag('Vse objave', null));
                tags.forEach(t => elements.tagFilter.appendChild(makeTag(t, t)));
            }

            function updateHeadMeta(){
                const pageUrl = BASE_URL + location.pathname + location.search;
                const titleParts = ['News'];
                if (state.activeTag) titleParts.push(`Tag: ${state.activeTag}`);
                if (state.query) titleParts.push(`Iskanje: ${state.query}`);
                const title = `${titleParts.join(' – ')} – Sonce Slovenije`;
                document.title = title;
                const desc = state.filteredPosts.length ? `Na strani je ${state.filteredPosts.length} objav.` : 'Najnovejše novice in objave Sindikata Sonce Koper.';
                const metaDesc = document.querySelector('meta[name="description"]');
                if (metaDesc) metaDesc.setAttribute('content', desc);
                const ogTitle = document.querySelector('meta[property="og:title"]');
                if (ogTitle) ogTitle.setAttribute('content', title);
                const ogDesc = document.querySelector('meta[property="og:description"]');
                if (ogDesc) ogDesc.setAttribute('content', desc);
                const ogUrl = document.querySelector('meta[property="og:url"]');
                if (ogUrl) ogUrl.setAttribute('content', pageUrl);
                const twTitle = document.querySelector('meta[name="twitter:title"]');
                if (twTitle) twTitle.setAttribute('content', title);
                const twDesc = document.querySelector('meta[name="twitter:description"]');
                if (twDesc) twDesc.setAttribute('content', desc);
            }

            function updateJsonLd(){
                try {
                    const list = state.filteredPosts.slice(0, 10).map((p, idx) => ({
                        '@type': 'ListItem',
                        position: idx + 1,
                        url: BASE_URL + '/news/post.html?' + ((p.path || p.link) ? ('path=' + encodeURIComponent(p.path || p.link)) : ('slug=' + encodeURIComponent(p.slug))),
                        name: p.title || ''
                    }));
                    const json = {
                        '@context': 'https://schema.org',
                        '@type': 'CollectionPage',
                        name: 'News – Sonce Slovenije',
                        url: BASE_URL + '/news/',
                        hasPart: {
                            '@type': 'ItemList',
                            itemListElement: list
                        }
                    };
                    const node = document.getElementById('news-jsonld');
                    if (node) node.textContent = JSON.stringify(json);
                } catch (e) {}
            }

            function applyFilters(){
                state.filteredPosts = state.activeTag ? 
                    state.allPosts.filter(p => (p.tags || []).includes(state.activeTag)) : 
                    state.allPosts.slice();
                
                if (state.query){
                    const q = normalizeText(state.query);
                    state.filteredPosts = state.filteredPosts.filter(p => {
                        const hay = normalizeText([
                            p.title,
                            p.summary || p.description || p.excerpt,
                            (p.tags || []).join(' '),
                            p.author
                        ].filter(Boolean).join(' '));
                        return hay.includes(q);
                    });
                }
                
                const sortKey = state.sortBy;
                state.filteredPosts.sort((a,b)=>{
                    switch (sortKey){
                        case 'date_asc':
                            return (a.date||'').localeCompare(b.date||'');
                        case 'title_asc':
                            return (a.title||'').localeCompare(b.title||'', 'sl', { sensitivity: 'base' });
                        case 'title_desc':
                            return (b.title||'').localeCompare(a.title||'', 'sl', { sensitivity: 'base' });
                        case 'readtime_asc': {
                            const av = Number.isFinite(a.readingTimeMinutes) ? a.readingTimeMinutes : Number.POSITIVE_INFINITY;
                            const bv = Number.isFinite(b.readingTimeMinutes) ? b.readingTimeMinutes : Number.POSITIVE_INFINITY;
                            return av - bv;
                        }
                        case 'readtime_desc': {
                            const av = Number.isFinite(a.readingTimeMinutes) ? a.readingTimeMinutes : Number.NEGATIVE_INFINITY;
                            const bv = Number.isFinite(b.readingTimeMinutes) ? b.readingTimeMinutes : Number.NEGATIVE_INFINITY;
                            return bv - av;
                        }
                        case 'date_desc':
                        default:
                            return (b.date||'').localeCompare(a.date||'');
                    }
                });
                
                const totalPages = Math.max(1, Math.ceil(state.filteredPosts.length / state.pageSize));
                if (state.currentPage > totalPages) state.currentPage = 1;
                
                renderPosts();
                renderPagination();
                renderTagFilter();
                updateHeadMeta();
                updateJsonLd();
            }

            async function load(){
                try {
                    const res = await fetch('/content/news/index.json', { cache: 'no-cache' });
                    if (!res.ok) throw new Error('Failed to load index.json');
                    
                    const data = await res.json();
                    const raw = Array.isArray(data) ? data : Array.isArray(data.posts) ? data.posts : [];
                    state.allPosts = raw.map(normalizePost);
                    
                    readQuery();
                    applyFilters();
                } catch (e) {
                    console.error('Error loading news:', e);
                    elements.loading.classList.add('hidden');
                    elements.empty.textContent = 'Napaka pri nalaganju novic.';
                    elements.empty.classList.remove('hidden');
                }
            }

            // Initialize
            if (elements.year) elements.year.textContent = new Date().getFullYear();
            
            if (elements.pageSizeSelect){
                elements.pageSizeSelect.addEventListener('change', () => {
                    const val = parseInt(elements.pageSizeSelect.value, 10);
                    state.pageSize = Number.isFinite(val) && val > 0 ? val : state.pageSize;
                    state.currentPage = 1;
                    writeQuery();
                    applyFilters();
                });
            }

            if (elements.searchInput){
                const onSearch = debounce(() => {
                    state.query = elements.searchInput.value.trim();
                    state.currentPage = 1;
                    writeQuery();
                    applyFilters();
                }, 200);
                elements.searchInput.addEventListener('input', onSearch);
            }

            if (elements.sortSelect){
                elements.sortSelect.addEventListener('change', () => {
                    state.sortBy = elements.sortSelect.value;
                    state.currentPage = 1;
                    writeQuery();
                    applyFilters();
                });
            }
            
            load();
        })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" defer></script>
</body>
</html>